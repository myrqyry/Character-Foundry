<!DOCTYPE html>
<html>
<head>
    <title>Audio Clipper</title>
    <style>
        #waveform {
            width: 100%;
            height: 128px;
        }
        #modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
        }
        .modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
        }
    </style>
</head>
<body>

<input type="file" id="audio-upload" accept="audio/*">

<div id="modal">
    <div class="modal-content">
        <h2>Clip Audio</h2>
        <div id="waveform"></div>
        <button id="save-clip">Save Clip</button>
    </div>
</div>

<script src="https://unpkg.com/wavesurfer.js"></script>
<script src="https://unpkg.com/wavesurfer.js/dist/plugin/wavesurfer.regions.min.js"></script>
<script>
    var wavesurfer = null;
    var originalFile = null;

    window.addEventListener('message', function(event) {
        if (event.data.type === 'audioFile') {
            originalFile = event.data.file;
            var modal = document.getElementById('modal');
            modal.style.display = "block";

            if (wavesurfer) {
                wavesurfer.destroy();
            }

            wavesurfer = WaveSurfer.create({
                container: '#waveform',
                waveColor: 'violet',
                progressColor: 'purple',
                plugins: [
                    WaveSurfer.regions.create({
                        regions: [
                            {
                                start: 1,
                                end: 3,
                                color: 'rgba(0, 255, 0, 0.1)'
                            }
                        ],
                        dragSelection: {
                            slop: 5
                        }
                    })
                ]
            });

            wavesurfer.load(URL.createObjectURL(originalFile));
        }
    });

    document.getElementById('save-clip').onclick = function() {
        if (!wavesurfer || !originalFile) return;

        var region = wavesurfer.regions.list[Object.keys(wavesurfer.regions.list)[0]];
        if (region) {
            var start = region.start;
            var end = region.end;

            var originalBuffer = wavesurfer.backend.buffer;
            var duration = end - start;

            var clippedBuffer = wavesurfer.backend.ac.createBuffer(
                originalBuffer.numberOfChannels,
                originalBuffer.sampleRate * duration,
                originalBuffer.sampleRate
            );

            for (var i = 0; i < originalBuffer.numberOfChannels; i++) {
                var channelData = originalBuffer.getChannelData(i);
                var clippedChannelData = clippedBuffer.getChannelData(i);
                var startSample = Math.floor(start * originalBuffer.sampleRate);

                for (var j = 0; j < clippedChannelData.length; j++) {
                    clippedChannelData[j] = channelData[startSample + j];
                }
            }

            var wavBlob = audioBufferToWav(clippedBuffer);

            var reader = new FileReader();
            reader.onloadend = function() {
                var base64data = reader.result;
                var event = new CustomEvent('audioClipped', { detail: base64data });
                window.parent.document.dispatchEvent(event);

                document.getElementById('modal').style.display = "none";
                wavesurfer.destroy();
            };
            reader.readAsDataURL(wavBlob);
        }
    };

    function audioBufferToWav(buffer) {
        var numOfChan = buffer.numberOfChannels,
            btwLength = buffer.length * numOfChan * 2 + 44,
            btwArrBuff = new ArrayBuffer(btwLength),
            btwView = new DataView(btwArrBuff),
            btwOffset = 0;

        function writeString(view, offset, string) {
            for (var i = 0; i < string.length; i++) {
                view.setUint8(offset + i, string.charCodeAt(i));
            }
        }

        function floatTo16BitPCM(output, offset, input) {
            for (var i = 0; i < input.length; i++, offset += 2) {
                var s = Math.max(-1, Math.min(1, input[i]));
                output.setInt16(offset, s < 0 ? s * 0x8000 : s * 0x7FFF, true);
            }
        }

        writeString(btwView, btwOffset, 'RIFF'); btwOffset += 4;
        btwView.setUint32(btwOffset, btwLength - 8, true); btwOffset += 4;
        writeString(btwView, btwOffset, 'WAVE'); btwOffset += 4;
        btwView.setUint32(btwOffset, 16, true); btwOffset += 4;
        btwView.setUint16(btwOffset, 1, true); btwOffset += 2;
        btwView.setUint16(btwOffset, numOfChan, true); btwOffset += 2;
        btwView.setUint32(btwOffset, buffer.sampleRate, true); btwOffset += 4;
        btwView.setUint32(btwOffset, buffer.sampleRate * numOfChan * 2, true); btwOffset += 4;
        btwView.setUint16(btwOffset, numOfChan * 2, true); btwOffset += 2;
        btwView.setUint16(btwOffset, 16, true); btwOffset += 2;
        writeString(btwView, btwOffset, 'data'); btwOffset += 4;
        btwView.setUint32(btwOffset, btwLength - btwOffset - 4, true); btwOffset += 4;

        floatTo16BitPCM(btwView, btwOffset, buffer.getChannelData(0));

        return new Blob([btwArrBuff], { type: 'audio/wav' });
    }
</script>

</body>
</html>
